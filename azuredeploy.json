{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "vmName": { "type": "string" },
        "vmSSName": { "type": "string" },
        "instanceCount": { "type": "string" },
        "adminUsername": { "type": "string" },
        "adminPassword": { "type": "securestring" },
        "resourcePrefix": { "type": "string" },  
        "ADMIN_EMAIL": { "type": "string" }, 
        "ORG_SHORT_NAME": { "type": "string" }, 
        "ORG_LONG_NAME": { "type": "string" },
        "KEY_DIR": { "type": "string" },
        "sa_name": { "type": "string" },
        "rg_name": { "type": "string" },
        "container_name01": { "type": "string" }, 
        "container_name02": { "type": "string" } 
    },
    "variables": {
        "deploymentApiVersion": "2015-01-01",
        "location": "[resourceGroup().location]",
        "baseUrl": "https://raw.githubusercontent.com/chef-customers/chef-automate-azure/OrchestrationTemplate/",
        "runnerURL": "[concat(variables('baseUrl'),'nestedTemplates/runner.json')]",
        "standaloneURL": "[concat(variables('baseUrl'),'nestedTemplates/chef_standalone.json')]",
        "automateURL": "[concat(variables('baseUrl'),'nestedTemplates/chef_automate.json')]",
        "serverExtensionURL": "[concat(variables('baseUrl'),'nestedTemplates/install_chef_server.sh')]"
    },
    "resources": [
        {
            "name": "StandAloneResource",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('deploymentApiVersion')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('standaloneURL')]",
                    "contentVersion": "1.0.0.0"
                },
            "parameters": { 
                "vmName":  {"value" : "[concat(uniquestring(parameters('vmName')), 'ChefStandAlone')]"},
                "adminUsername": {"value" : "[parameters('adminUsername')]"},
                "adminPassword": {"value" : "[parameters('adminPassword')]"},
                "ADMIN_EMAIL": { "value" : "[parameters('ADMIN_EMAIL')]" }, 
                "ORG_SHORT_NAME": {"value" : "[parameters('ORG_SHORT_NAME')]" }, 
                "ORG_LONG_NAME": { "value" : "[parameters('ORG_LONG_NAME')]"},
                "KEY_DIR": { "value" : "[parameters('KEY_DIR')]" },
                "sa_name": { "value" : "[parameters('sa_name')]" },
                "rg_name": {"value" : "[parameters('rg_name')]" },
                "container_name01": { "value" : "[parameters('container_name01')]"}, 
                "container_name02": { "value" : "[parameters('container_name02')]"} 
              }
            }    
        },
        {
            "name": "ChefAutomateResource",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('deploymentApiVersion')]",
            "dependsOn": [
                "StandAloneResource"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('automateURL')]",
                    "contentVersion": "1.0.0.0"
              },
            "parameters": { 
                "vmName":  {"value" : "[concat(uniquestring(parameters('vmName')), 'ChefAutomate')]"},
                "adminUsername": {"value" : "[parameters('adminUsername')]"},
                "adminPassword": {"value" : "[parameters('adminPassword')]"},
                "KEY_DIR": { "value" : "[parameters('KEY_DIR')]" }
                }
           }    
        },
        {
            "name": "scalesetResource",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('deploymentApiVersion')]",
            "dependsOn": [
                "StandAloneResource",
                "ChefAutomateResource"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('runnerURL')]",
                    "contentVersion": "1.0.0.0"
                },
            "parameters": { 
                "vmName":  {"value" : "uniquestring([parameters('vmName'))]"},
                "vmSSName": {"value" : "uniquestring([parameters('vmSSName')]"},
                "instanceCount": {"value" : "[parameters('instanceCount')]"},
                "adminUsername": {"value" : "[parameters('adminUsername')]"},
                "adminPassword": {"value" : "[parameters('adminPassword')]"},
                "resourcePrefix":{"value" : "[parameters('resourcePrefix')]"} 
                }
            }    
        }
    ],
    "outputs": {
        
    }
}
